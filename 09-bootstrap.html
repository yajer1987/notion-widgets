<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>09 - Bootstrap 初始化流程</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=Source+Code+Pro:wght@400;500&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans TC',sans-serif;background:#fff;color:#1a1a1a;padding:40px;font-size:14px;line-height:1.6}
.container{max-width:820px;margin:0 auto}
h1{font-size:22px;font-weight:700;margin-bottom:4px}
.sub{font-size:13px;color:#666;font-family:'Source Code Pro',monospace;margin-bottom:32px}
code{font-family:'Source Code Pro',monospace;font-size:12px;background:#f5f5f5;padding:1px 5px;border-radius:3px;color:#d14}

/* Timeline */
.tl{display:flex;gap:2px;margin-bottom:28px}
.tl-seg{flex:1;padding:8px 6px;text-align:center;font-size:11px;border-radius:4px;line-height:1.4;border-top:3px solid}
.tl-auto{border-color:#4a7fd4;background:#eff6ff}
.tl-manual{border-color:#3a9a5c;background:#f0fdf4}
.tl-b{font-weight:600;font-size:11px;margin-bottom:2px}

/* Phase */
.phase{border:1px solid #e5e5e5;border-radius:8px;overflow:hidden;margin-bottom:16px}
.phase-h{padding:10px 16px;font-weight:700;font-size:14px;border-bottom:1px solid #e5e5e5;background:#f9fafb;display:flex;align-items:center;gap:10px}
.phase-num{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0}
.phase-b{padding:14px 16px}

.steps{display:flex;flex-direction:column;gap:6px}
.s{display:flex;gap:10px;align-items:flex-start;padding:10px 14px;border:1px solid #e5e5e5;border-radius:6px;font-size:13px}
.s-n{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;color:#fff}
.n-blue{background:#4a7fd4}.n-gray{background:#888}.n-green{background:#3a9a5c}.n-orange{background:#d97706}

/* Permission grid */
.perm-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:8px}
.perm{font-family:'Source Code Pro',monospace;font-size:11px;padding:3px 8px;background:#f5f5f5;border-radius:3px;color:#555}

.note{margin-top:24px;padding:14px 16px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;color:#444;background:#f9fafb;line-height:1.7}
.note b{color:#1a1a1a}
.wm{text-align:center;margin-top:24px;font-size:11px;color:#bbb;font-family:'Source Code Pro',monospace}
</style>
</head>
<body>
<div class="container">
  <h1>09 — Bootstrap 初始化流程</h1>
  <div class="sub">Auth Service 首次啟動 → 正式運作的完整路徑</div>

  <div class="tl">
    <div class="tl-seg tl-auto"><div class="tl-b" style="color:#1e40af">自動</div>建立 auth:* Permission</div>
    <div class="tl-seg tl-auto"><div class="tl-b" style="color:#1e40af">自動</div>建立 initial-admin Role</div>
    <div class="tl-seg tl-auto"><div class="tl-b" style="color:#1e40af">自動</div>建立管理者帳號</div>
    <div class="tl-seg tl-manual"><div class="tl-b" style="color:#166534">手動</div>管理者登入</div>
    <div class="tl-seg tl-manual"><div class="tl-b" style="color:#166534">CI/CD</div>Import 正式角色</div>
    <div class="tl-seg tl-manual"><div class="tl-b" style="color:#166534">手動</div>建帳號 指派 Role</div>
  </div>

  <div class="phase">
    <div class="phase-h"><div class="phase-num" style="background:#4a7fd4">1</div>首次啟動 — 自動執行</div>
    <div class="phase-b">
      <div class="steps">
        <div class="s"><div class="s-n n-blue">P</div><div>
          建立 13 個 <code>auth:*</code> Permission records（hard-coded）
          <div class="perm-grid">
            <div class="perm">auth:accounts:read</div><div class="perm">auth:accounts:write</div>
            <div class="perm">auth:roles:read</div><div class="perm">auth:roles:manage</div>
            <div class="perm">auth:permissions:read</div><div class="perm">auth:scopes:read</div>
            <div class="perm">auth:scopes:manage</div><div class="perm">auth:sessions:read</div>
            <div class="perm">auth:sessions:delete</div><div class="perm">auth:idp:read</div>
            <div class="perm">auth:idp:manage</div><div class="perm">auth:settings:read</div>
            <div class="perm">auth:settings:manage</div>
          </div>
        </div></div>
        <div class="s"><div class="s-n n-green">R</div><div>建立 <b>initial-admin</b> Role：包含全部 13 個 auth:* permission</div></div>
        <div class="s"><div class="s-n n-blue">A</div><div>若環境變數設定了 INIT_ADMIN：建立本地帳號（username/password 從環境變數讀取），指派 {initial-admin, scope: null}，設定 passwordChangeRequired: true</div></div>
      </div>
    </div>
  </div>

  <div class="phase">
    <div class="phase-h"><div class="phase-num" style="background:#3a9a5c">2</div>管理者首次操作 — 手動 / CI/CD</div>
    <div class="phase-b">
      <div class="steps">
        <div class="s"><div class="s-n n-orange">①</div><div>管理者登入 → 用環境變數帳密 POST /tokens → 取得 JWT → 被要求改密碼</div></div>
        <div class="s"><div class="s-n n-orange">②</div><div>呼叫 Import API：建立 scc-web 的 Permission、Scope、Role 架構</div></div>
        <div class="s"><div class="s-n n-orange">③</div><div>建立使用者帳號並指派 Role Assignment</div></div>
        <div class="s"><div class="s-n n-orange">④</div><div>（可選）管理者帳號改指派正式的 SuperAdmin role，移除 initial-admin</div></div>
      </div>
    </div>
  </div>

  <div class="phase">
    <div class="phase-h"><div class="phase-num" style="background:#888">3</div>正式運作</div>
    <div class="phase-b">
      <div class="steps">
        <div class="s"><div class="s-n n-gray">✓</div><div>使用者正常登入，JWT 包含正式 roleAssignments + permissions</div></div>
        <div class="s"><div class="s-n n-gray">✓</div><div>後續版本升級 → CI/CD 自動呼叫 Import (merge) 更新定義</div></div>
      </div>
    </div>
  </div>

  <div class="note">
    <b>設計重點：</b>Bootstrap 只建立 Auth Service 自己的 Permission（auth:*），不預設應用層角色。應用層的 Permission/Role/Scope 透過 Import API 建立。initial-admin 是臨時角色，目的是讓系統有第一個能操作 Auth API 的帳號。
  </div>
  <div class="wm">Auth Service v3.2 · Bootstrap Initialization Flow</div>
</div>
</body>
</html>
