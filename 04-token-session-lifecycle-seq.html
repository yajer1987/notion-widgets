<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>4. Token èˆ‡ Session ç”Ÿå‘½é€±æœŸ</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=Source+Code+Pro:wght@400;500&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans TC',sans-serif;background:#fff;color:#1a1a1a;padding:0;font-size:14px}

.page{max-width:1200px;margin:0 auto;padding:36px 40px 48px}
.title{font-size:20px;font-weight:700;margin-bottom:4px;color:#1a1a1a}
.title-line{height:3px;background:linear-gradient(90deg,#4a7fd4 0%,#4a7fd4 40%,#e5e5e5 40%);margin-bottom:28px;border-radius:2px}

svg{display:block;margin:0 auto}
svg text{font-family:'Noto Sans TC',sans-serif}

.participant-box{fill:#f0f4fa;stroke:#b0c4de;stroke-width:1.5;rx:6}
.participant-label{font-size:13px;font-weight:600;fill:#2c3e6b;text-anchor:middle;dominant-baseline:central}
.lifeline{stroke:#d0d0d0;stroke-width:1;stroke-dasharray:6,4}
.arrow-solid{stroke:#555;stroke-width:1.5;fill:none;marker-end:url(#arrowhead)}
.arrow-dash{stroke:#888;stroke-width:1.2;fill:none;stroke-dasharray:6,4;marker-end:url(#arrowhead-light)}
.msg-label{font-size:12px;fill:#333}
.msg-label-bold{font-size:12px;fill:#1a1a1a;font-weight:600}
.msg-sub{font-size:10.5px;fill:#888}
.msg-code{font-size:11.5px;fill:#c0392b;font-family:'Source Code Pro',monospace}
.msg-error{font-size:11.5px;fill:#c0392b;font-weight:500}
.msg-success{font-size:11.5px;fill:#1a7a3a;font-weight:500}
.activation{fill:#e8eefc;stroke:#b0c4de;stroke-width:1;rx:2}
.activation-db{fill:#f0e8fc;stroke:#c4b0de;stroke-width:1;rx:2}
.frame{fill:none;stroke:#bbb;stroke-width:1;stroke-dasharray:4,3;rx:4}
.frame-label-bg{fill:#f5f5f5;stroke:none}
.frame-label{font-size:10px;fill:#888;font-weight:600;letter-spacing:0.5px}
.phase-line{stroke:#ccc;stroke-width:1;stroke-dasharray:2,2}
.phase-bg{fill:#f9fafb;stroke:none}
.phase-label{font-size:10px;fill:#999;font-weight:600;text-anchor:middle;letter-spacing:1px}
.note-box{fill:#fffde7;stroke:#e0d97e;stroke-width:1;rx:4}
.note-text{font-size:10.5px;fill:#6b6320}
.note-box-blue{fill:#eef4ff;stroke:#a8c4e8;stroke-width:1;rx:4}
.note-text-blue{font-size:10.5px;fill:#2c5282}
.footer{font-size:11px;fill:#bbb;text-anchor:middle;font-family:'Source Code Pro',monospace}

.section-title{font-size:17px;font-weight:700;margin:36px 0 8px;color:#1a1a1a;border-bottom:2px solid #e5e5e5;padding-bottom:6px}
.info{margin-top:20px;padding:14px 16px;border-left:3px solid #4a7fd4;background:#f8fafd;font-size:13px;color:#444;line-height:1.7}
.info b{color:#1a1a1a}
.info code{font-family:'Source Code Pro',monospace;font-size:12px;background:#eef2f7;padding:1px 5px;border-radius:3px;color:#c0392b}
</style>
</head>
<body>
<div class="page">
  <div class="title">4. Token èˆ‡ Session ç”Ÿå‘½é€±æœŸ</div>
  <div class="title-line"></div>

  <!-- ================================================================ -->
  <!-- PART A: JWT vs Session Comparison + Timeline                     -->
  <!-- ================================================================ -->
  <div class="section-title">A. JWT èˆ‡ Session å°æ¯” + æ™‚é–“è»¸</div>

  <svg width="1100" height="400" viewBox="0 0 1100 400">
    <defs>
      <marker id="arrowhead-timeline" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#555"/></marker>
    </defs>

    <!-- Comparison Table -->
    <!-- Header -->
    <rect x="30" y="10" width="200" height="32" rx="4" fill="#e8eefc" stroke="#b0c4de" stroke-width="1"/>
    <text x="130" y="30" text-anchor="middle" font-size="12" font-weight="600" fill="#2c3e6b">é …ç›®</text>
    <rect x="230" y="10" width="250" height="32" rx="4" fill="#dbeafe" stroke="#93b4e0" stroke-width="1"/>
    <text x="355" y="30" text-anchor="middle" font-size="12" font-weight="600" fill="#1e40af">JWT (Access Token)</text>
    <rect x="480" y="10" width="250" height="32" rx="4" fill="#f0e8fc" stroke="#c4b0de" stroke-width="1"/>
    <text x="605" y="30" text-anchor="middle" font-size="12" font-weight="600" fill="#6b21a8">Session</text>

    <!-- Row 1: å­˜å„²ä½ç½® -->
    <rect x="30" y="46" width="200" height="28" fill="#f9fafb" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="40" y="64" font-size="11.5" fill="#555">å­˜å„²ä½ç½®</text>
    <rect x="230" y="46" width="250" height="28" fill="#fafcff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="240" y="64" font-size="11.5" fill="#333">Client ç«¯ï¼ˆlocalStorage / memoryï¼‰</text>
    <rect x="480" y="46" width="250" height="28" fill="#faf8ff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="490" y="64" font-size="11.5" fill="#333">Server ç«¯ï¼ˆè³‡æ–™åº« recordï¼‰</text>

    <!-- Row 2: æœ‰æ•ˆæœŸ -->
    <rect x="30" y="74" width="200" height="28" fill="#fff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="40" y="92" font-size="11.5" fill="#555">æœ‰æ•ˆæœŸ</text>
    <rect x="230" y="74" width="250" height="28" fill="#fff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="240" y="92" font-size="11.5" fill="#333" font-weight="600">30 åˆ†é˜ï¼ˆçŸ­æœŸï¼‰</text>
    <rect x="480" y="74" width="250" height="28" fill="#fff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="490" y="92" font-size="11.5" fill="#333" font-weight="600">7 å¤©ï¼ˆé•·æœŸï¼‰</text>

    <!-- Row 3: é©—è­‰æ–¹å¼ -->
    <rect x="30" y="102" width="200" height="28" fill="#f9fafb" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="40" y="120" font-size="11.5" fill="#555">é©—è­‰æ–¹å¼</text>
    <rect x="230" y="102" width="250" height="28" fill="#fafcff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="240" y="120" font-size="11.5" fill="#333">Statelessï¼ˆé©—ç°½å + expï¼‰</text>
    <rect x="480" y="102" width="250" height="28" fill="#faf8ff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="490" y="120" font-size="11.5" fill="#333">Statefulï¼ˆæŸ¥ DB recordï¼‰</text>

    <!-- Row 4: æ’¤éŠ· -->
    <rect x="30" y="130" width="200" height="28" fill="#fff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="40" y="148" font-size="11.5" fill="#555">å¯å¦æ’¤éŠ·</text>
    <rect x="230" y="130" width="250" height="28" fill="#fff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="240" y="148" font-size="11.5" fill="#c0392b">âŒ ä¸å¯ï¼ˆç­‰éæœŸï¼‰</text>
    <rect x="480" y="130" width="250" height="28" fill="#fff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="490" y="148" font-size="11.5" fill="#1a7a3a">âœ… å¯å³æ™‚æ’¤éŠ·ï¼ˆåˆªé™¤ recordï¼‰</text>

    <!-- Row 5: ç”¨é€” -->
    <rect x="30" y="158" width="200" height="28" fill="#f9fafb" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="40" y="176" font-size="11.5" fill="#555">ä¸»è¦ç”¨é€”</text>
    <rect x="230" y="158" width="250" height="28" fill="#fafcff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="240" y="176" font-size="11.5" fill="#333">API è«‹æ±‚èªè­‰ + æ¬Šé™è³‡è¨Š</text>
    <rect x="480" y="158" width="250" height="28" fill="#faf8ff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="490" y="176" font-size="11.5" fill="#333">å¼·åˆ¶ç™»å‡º + è¿½è¹¤åœ¨ç·šç‹€æ…‹</text>

    <!-- Row 6: å…§å®¹ -->
    <rect x="30" y="186" width="200" height="32" fill="#fff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="40" y="206" font-size="11.5" fill="#555">æ”œå¸¶å…§å®¹</text>
    <rect x="230" y="186" width="250" height="32" fill="#fff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="240" y="200" font-size="10.5" fill="#333">sub, username, sessionId,</text>
    <text x="240" y="214" font-size="10.5" fill="#333">roleAssignments, permissions, exp</text>
    <rect x="480" y="186" width="250" height="32" fill="#fff" stroke="#e5e5e5" stroke-width="0.5"/>
    <text x="490" y="200" font-size="10.5" fill="#333">sessionId, accountId, createdAt,</text>
    <text x="490" y="214" font-size="10.5" fill="#333">expiresAt, status, ipAddress</text>

    <!-- ============ TIMELINE ============ -->
    <text x="30" y="258" font-size="13" font-weight="600" fill="#1a1a1a">æ™‚é–“è»¸</text>

    <!-- Time axis -->
    <line x1="30" y1="290" x2="1070" y2="290" stroke="#555" stroke-width="1.5" marker-end="url(#arrowhead-timeline)"/>
    <text x="1075" y="294" font-size="10" fill="#888">time</text>

    <!-- Session bar (background) -->
    <rect x="50" y="270" width="960" height="12" rx="3" fill="#f0e8fc" stroke="#c4b0de" stroke-width="1"/>
    <text x="530" y="265" text-anchor="middle" font-size="10" fill="#7c5cad" font-weight="600">Sessionï¼ˆ7 å¤©ï¼‰</text>

    <!-- JWT #1 -->
    <rect x="50" y="300" width="180" height="20" rx="3" fill="#dbeafe" stroke="#93b4e0" stroke-width="1"/>
    <text x="140" y="314" text-anchor="middle" font-size="10" fill="#1e40af" font-weight="500">JWT #1ï¼ˆ30minï¼‰</text>

    <!-- Refresh arrow 1 -->
    <line x1="230" y1="320" x2="230" y2="340" stroke="#d97706" stroke-width="1.5"/>
    <text x="235" y="340" font-size="9" fill="#d97706" font-weight="600">refresh</text>

    <!-- JWT #2 -->
    <rect x="240" y="300" width="180" height="20" rx="3" fill="#dbeafe" stroke="#93b4e0" stroke-width="1"/>
    <text x="330" y="314" text-anchor="middle" font-size="10" fill="#1e40af" font-weight="500">JWT #2ï¼ˆ30minï¼‰</text>

    <!-- Refresh arrow 2 -->
    <line x1="420" y1="320" x2="420" y2="340" stroke="#d97706" stroke-width="1.5"/>
    <text x="425" y="340" font-size="9" fill="#d97706" font-weight="600">refresh</text>

    <!-- JWT #3 -->
    <rect x="430" y="300" width="180" height="20" rx="3" fill="#dbeafe" stroke="#93b4e0" stroke-width="1"/>
    <text x="520" y="314" text-anchor="middle" font-size="10" fill="#1e40af" font-weight="500">JWT #3ï¼ˆ30minï¼‰</text>

    <!-- dots -->
    <text x="630" y="314" font-size="14" fill="#888">Â· Â· Â·</text>

    <!-- JWT #N -->
    <rect x="680" y="300" width="180" height="20" rx="3" fill="#dbeafe" stroke="#93b4e0" stroke-width="1"/>
    <text x="770" y="314" text-anchor="middle" font-size="10" fill="#1e40af" font-weight="500">JWT #Nï¼ˆ30minï¼‰</text>

    <!-- Session expires -->
    <line x1="1010" y1="268" x2="1010" y2="330" stroke="#c0392b" stroke-width="1.5" stroke-dasharray="4,3"/>
    <text x="1015" y="340" font-size="10" fill="#c0392b" font-weight="600">Session éæœŸ</text>
    <text x="1015" y="353" font-size="9" fill="#c0392b">Refresh å¤±æ•— â†’ é‡æ–°ç™»å…¥</text>

    <!-- Login marker -->
    <line x1="50" y1="268" x2="50" y2="330" stroke="#1a7a3a" stroke-width="1.5" stroke-dasharray="4,3"/>
    <text x="55" y="360" font-size="10" fill="#1a7a3a" font-weight="600">ç™»å…¥</text>

    <!-- Note -->
    <rect x="750" y="348" width="260" height="44" rx="4" fill="#fffde7" stroke="#e0d97e" stroke-width="1"/>
    <text x="760" y="364" font-size="10.5" fill="#6b6320">æ¯æ¬¡ refresh éƒ½æœƒé‡æ–°æŸ¥è©¢ DB</text>
    <text x="760" y="379" font-size="10.5" fill="#6b6320">ç¢ºä¿ roleAssignments + permissions æœ€æ–°</text>
  </svg>

  <!-- ================================================================ -->
  <!-- PART B: Refresh Flow (Sequence Diagram)                          -->
  <!-- ================================================================ -->
  <div class="section-title">B. Token Refresh æµç¨‹</div>

  <svg width="1100" height="740" viewBox="0 0 1100 740">
    <defs>
      <marker id="arrowhead2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#555"/></marker>
      <marker id="arrowhead2-light" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#888"/></marker>
      <marker id="arrowhead2-green" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#1a7a3a"/></marker>
      <marker id="arrowhead2-red" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#c0392b"/></marker>
    </defs>

    <!-- Participants -->
    <rect class="participant-box" x="70" y="10" width="100" height="40"/>
    <text class="participant-label" x="120" y="30">å‰ç«¯</text>
    <rect class="participant-box" x="340" y="10" width="130" height="40"/>
    <text class="participant-label" x="405" y="30">Auth Service</text>
    <rect class="participant-box" x="650" y="10" width="100" height="40"/>
    <text class="participant-label" x="700" y="30">è³‡æ–™åº«</text>

    <!-- Lifelines -->
    <line class="lifeline" x1="120" y1="50" x2="120" y2="650"/>
    <line class="lifeline" x1="405" y1="50" x2="405" y2="650"/>
    <line class="lifeline" x1="700" y1="50" x2="700" y2="650"/>

    <!-- Activation -->
    <rect class="activation" x="398" y="85" width="14" height="505"/>
    <rect class="activation-db" x="693" y="210" width="14" height="36"/>
    <rect class="activation-db" x="693" y="385" width="14" height="36"/>
    <rect class="activation-db" x="693" y="465" width="14" height="36"/>

    <!-- ===== Step 1: POST refresh ===== -->
    <line x1="120" y1="90" x2="398" y2="90" stroke="#555" stroke-width="1.5" marker-end="url(#arrowhead2)"/>
    <text class="msg-code" x="155" y="83">POST /tokens/actions/refresh</text>
    <text class="msg-sub" x="155" y="108">{refreshToken: "eyJ..."}</text>

    <!-- ===== Step 2: Validate refreshToken (self-loop, spacious) ===== -->
    <path d="M412,140 L490,140 L490,170 L412,170" stroke="#555" stroke-width="1.5" fill="none" marker-end="url(#arrowhead2)"/>
    <text class="msg-label-bold" x="420" y="134">â‘  é©—è­‰ refreshToken</text>
    <text class="msg-sub" x="500" y="152">æª¢æŸ¥ JWT ç°½åæ˜¯å¦æœ‰æ•ˆ</text>
    <text class="msg-sub" x="500" y="166">æª¢æŸ¥ exp æ˜¯å¦éæœŸ</text>

    <!-- Note: Refresh Token Rotation -->
    <rect class="note-box" x="770" y="130" width="220" height="44"/>
    <text class="note-text" x="780" y="146">èˆŠ refreshToken ç”¨éå³å¤±æ•ˆ</text>
    <text class="note-text" x="780" y="161">ï¼ˆRefresh Token Rotationï¼‰</text>

    <!-- ===== Step 3: Query session from DB ===== -->
    <line x1="412" y1="220" x2="693" y2="220" stroke="#555" stroke-width="1.5" marker-end="url(#arrowhead2)"/>
    <text class="msg-label-bold" x="440" y="214">â‘¡ æŸ¥è©¢ Session</text>
    <text class="msg-sub" x="440" y="235">å¾ refreshToken payload å–å‡º sessionIdï¼ŒæŸ¥ DB</text>

    <line x1="693" y1="240" x2="412" y2="240" stroke="#888" stroke-width="1.2" stroke-dasharray="6,4" marker-end="url(#arrowhead2-light)"/>
    <text class="msg-sub" x="450" y="258">å›å‚³ Session recordï¼ˆstatus, expiresAt...ï¼‰</text>

    <!-- ===== Step 4: Validate session (frame) ===== -->
    <rect class="frame" x="340" y="278" width="280" height="75"/>
    <rect class="frame-label-bg" x="341" y="278" width="100" height="18"/>
    <text class="frame-label" x="348" y="290">â‘¢ é©—è­‰ Session</text>

    <path d="M412,308 L490,308 L490,333 L412,333" stroke="#555" stroke-width="1.5" fill="none" marker-end="url(#arrowhead2)"/>
    <text class="msg-label" x="420" y="303">æª¢æŸ¥ status = active?</text>
    <text class="msg-error" x="500" y="328">revoked / expired / deleted â†’ 401</text>

    <!-- Error return -->
    <line x1="398" y1="365" x2="127" y2="365" stroke="#c0392b" stroke-width="1.2" stroke-dasharray="6,4" marker-end="url(#arrowhead2-red)"/>
    <text class="msg-error" x="165" y="360">Session ç„¡æ•ˆ â†’ 401ï¼ˆéœ€é‡æ–°ç™»å…¥ï¼‰</text>

    <!-- ===== Phase divider ===== -->
    <rect class="phase-bg" x="30" y="388" width="870" height="20"/>
    <line class="phase-line" x1="30" y1="398" x2="900" y2="398"/>
    <text class="phase-label" x="465" y="403">Session æœ‰æ•ˆ â†’ é‡æ–°ç°½ç™¼</text>

    <!-- ===== Step 5: Re-query roles ===== -->
    <line x1="412" y1="430" x2="693" y2="430" stroke="#555" stroke-width="1.5" marker-end="url(#arrowhead2)"/>
    <text class="msg-label-bold" x="440" y="425">â‘£ é‡æ–°æŸ¥è©¢ Role Assignments + Permissions</text>
    <line x1="693" y1="450" x2="412" y2="450" stroke="#888" stroke-width="1.2" stroke-dasharray="6,4" marker-end="url(#arrowhead2-light)"/>
    <text class="msg-sub" x="450" y="468">æœ€æ–°çš„ roleAssignments[], permissions[]</text>

    <!-- Note: key point -->
    <rect class="note-box-blue" x="770" y="415" width="220" height="72"/>
    <text class="note-text-blue" x="780" y="431">ğŸ”‘ é—œéµè¨­è¨ˆï¼š</text>
    <text class="note-text-blue" x="780" y="446">Refresh æœƒé‡æ–°æŸ¥ DBï¼Œ</text>
    <text class="note-text-blue" x="780" y="461">æ‰€ä»¥ç®¡ç†è€…ä¿®æ”¹ Role å¾Œï¼Œ</text>
    <text class="note-text-blue" x="780" y="476">ä¸‹æ¬¡ refresh å°±æœƒç”Ÿæ•ˆ</text>
    <line x1="770" y1="450" x2="720" y2="440" stroke="#a8c4e8" stroke-width="1" stroke-dasharray="3,2"/>

    <!-- ===== Step 6: Update session expiry ===== -->
    <line x1="412" y1="495" x2="693" y2="495" stroke="#555" stroke-width="1.5" marker-end="url(#arrowhead2)"/>
    <text class="msg-label" x="440" y="490">â‘¤ å»¶é•· Session expiresAt</text>

    <!-- ===== Step 7: Sign new JWT (self-loop) ===== -->
    <path d="M412,530 L490,530 L490,565 L412,565" stroke="#555" stroke-width="1.5" fill="none" marker-end="url(#arrowhead2)"/>
    <text class="msg-label-bold" x="420" y="524">â‘¥ ç°½ç™¼æ–° JWT + æ–° refreshToken</text>
    <text class="msg-sub" x="500" y="546">payload åŒ…å«æœ€æ–°çš„</text>
    <text class="msg-sub" x="500" y="560">roleAssignments + permissions</text>

    <!-- ===== Step 8: Return ===== -->
    <line x1="398" y1="590" x2="127" y2="590" stroke="#1a7a3a" stroke-width="1.5" marker-end="url(#arrowhead2-green)"/>
    <text class="msg-success" x="145" y="584">200 OK</text>
    <text class="msg-sub" x="145" y="604">{accessToken (æ–°), refreshToken (æ–°), expiresIn}</text>

    <!-- Bottom participants -->
    <rect class="participant-box" x="70" y="655" width="100" height="40"/>
    <text class="participant-label" x="120" y="675">å‰ç«¯</text>
    <rect class="participant-box" x="340" y="655" width="130" height="40"/>
    <text class="participant-label" x="405" y="675">Auth Service</text>
    <rect class="participant-box" x="650" y="655" width="100" height="40"/>
    <text class="participant-label" x="700" y="675">è³‡æ–™åº«</text>

    <text class="footer" x="465" y="725">Auth Service v3.2 Â· Token Refresh Sequence Diagram</text>
  </svg>

  <!-- ================================================================ -->
  <!-- PART C: Session State Transitions                                -->
  <!-- ================================================================ -->
  <div class="section-title">C. Session ç‹€æ…‹è½‰æ›</div>

  <svg width="1100" height="300" viewBox="0 0 1100 300">
    <defs>
      <marker id="arrowhead3" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#555"/></marker>
      <marker id="arrowhead3-red" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#c0392b"/></marker>
    </defs>

    <!-- Active state -->
    <rect x="80" y="80" width="140" height="50" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
    <text x="150" y="102" text-anchor="middle" font-size="14" font-weight="700" fill="#166534">Active</text>
    <text x="150" y="118" text-anchor="middle" font-size="10" fill="#166534">æ­£å¸¸ä½¿ç”¨ä¸­</text>

    <!-- Create arrow -->
    <line x1="150" y1="30" x2="150" y2="78" stroke="#22c55e" stroke-width="1.5" marker-end="url(#arrowhead3)"/>
    <text x="155" y="22" font-size="11" fill="#22c55e" font-weight="600">ç™»å…¥å»ºç«‹</text>

    <!-- Revoked state -->
    <rect x="380" y="20" width="140" height="50" rx="8" fill="#fef2f2" stroke="#ef4444" stroke-width="2"/>
    <text x="450" y="42" text-anchor="middle" font-size="14" font-weight="700" fill="#991b1b">Revoked</text>
    <text x="450" y="58" text-anchor="middle" font-size="10" fill="#991b1b">ä½¿ç”¨è€…ä¸»å‹•ç™»å‡º</text>

    <!-- Active â†’ Revoked -->
    <line x1="220" y1="90" x2="378" y2="55" stroke="#c0392b" stroke-width="1.5" marker-end="url(#arrowhead3-red)"/>
    <text x="260" y="50" font-size="10" fill="#c0392b">DELETE /sessions/{id}</text>
    <text x="260" y="63" font-size="10" fill="#c0392b">ï¼ˆä½¿ç”¨è€…ç™»å‡ºï¼‰</text>

    <!-- Expired state -->
    <rect x="380" y="105" width="140" height="50" rx="8" fill="#fff7ed" stroke="#f59e0b" stroke-width="2"/>
    <text x="450" y="127" text-anchor="middle" font-size="14" font-weight="700" fill="#92400e">Expired</text>
    <text x="450" y="143" text-anchor="middle" font-size="10" fill="#92400e">è‡ªç„¶éæœŸï¼ˆ7 å¤©ï¼‰</text>

    <!-- Active â†’ Expired -->
    <line x1="220" y1="110" x2="378" y2="125" stroke="#d97706" stroke-width="1.5" marker-end="url(#arrowhead3)"/>
    <text x="260" y="95" font-size="10" fill="#d97706">expiresAt åˆ°é”</text>
    <text x="260" y="108" font-size="10" fill="#d97706">ï¼ˆè‡ªç„¶éæœŸï¼‰</text>

    <!-- Deleted state -->
    <rect x="380" y="190" width="140" height="50" rx="8" fill="#f5f5f5" stroke="#a3a3a3" stroke-width="2"/>
    <text x="450" y="212" text-anchor="middle" font-size="14" font-weight="700" fill="#525252">Deleted</text>
    <text x="450" y="228" text-anchor="middle" font-size="10" fill="#525252">ç®¡ç†è€…å¼·åˆ¶ç™»å‡º</text>

    <!-- Active â†’ Deleted -->
    <line x1="220" y1="125" x2="378" y2="200" stroke="#555" stroke-width="1.5" marker-end="url(#arrowhead3)"/>
    <text x="240" y="180" font-size="10" fill="#555">Admin DELETE</text>
    <text x="240" y="193" font-size="10" fill="#555">/accounts/{id}/sessions</text>

    <!-- All â†’ need re-login -->
    <rect x="650" y="85" width="180" height="50" rx="8" fill="#e8eefc" stroke="#b0c4de" stroke-width="2"/>
    <text x="740" y="107" text-anchor="middle" font-size="13" font-weight="700" fill="#2c3e6b">éœ€é‡æ–°ç™»å…¥</text>
    <text x="740" y="123" text-anchor="middle" font-size="10" fill="#2c3e6b">Refresh å¤±æ•— â†’ 401</text>

    <line x1="520" y1="45" x2="648" y2="100" stroke="#888" stroke-width="1.2" stroke-dasharray="5,3" marker-end="url(#arrowhead3)"/>
    <line x1="520" y1="130" x2="648" y2="110" stroke="#888" stroke-width="1.2" stroke-dasharray="5,3" marker-end="url(#arrowhead3)"/>
    <line x1="520" y1="215" x2="648" y2="120" stroke="#888" stroke-width="1.2" stroke-dasharray="5,3" marker-end="url(#arrowhead3)"/>

    <!-- Note: Admin forced logout -->
    <rect class="note-box" x="650" y="195" width="260" height="58" rx="4"/>
    <text class="note-text" x="660" y="212">Admin å¼·åˆ¶é‡è¨­å¯†ç¢¼æ™‚ä¹Ÿæœƒè§¸ç™¼ Deletedï¼š</text>
    <text class="note-text" x="660" y="227">PATCH /accounts/{id} è¨­æ–°å¯†ç¢¼</text>
    <text class="note-text" x="660" y="242">â†’ è‡ªå‹•åˆªé™¤è©²å¸³è™Ÿæ‰€æœ‰ Session</text>

    <text class="footer" x="550" y="290">Auth Service v3.2 Â· Session State Transition Diagram</text>
  </svg>

  <div class="info">
    <b>JWT + Session é›™è»Œè¨­è¨ˆï¼š</b>JWT æä¾› stateless å¿«é€Ÿé©—è­‰ï¼ˆä¸æŸ¥ DBï¼‰ï¼ŒSession æä¾›å¼·åˆ¶ç™»å‡ºèƒ½åŠ›ã€‚æ¯æ¬¡ API è«‹æ±‚å…ˆé©— JWT ç°½å + expï¼Œå†æŸ¥ Session æ˜¯å¦ activeã€‚<br>
    <b>Refresh æ™‚é‡æŸ¥æ¬Šé™ï¼š</b>ç®¡ç†è€…ä¿®æ”¹ä½¿ç”¨è€… Role å¾Œï¼Œä¸éœ€ç­‰ä½¿ç”¨è€…é‡æ–°ç™»å…¥ï¼Œä¸‹æ¬¡ refreshï¼ˆæœ€å¤š 30 åˆ†é˜å…§ï¼‰æ–° JWT å°±æœƒåŒ…å«æœ€æ–°æ¬Šé™ã€‚<br>
    <b>Refresh Token Rotationï¼š</b>æ¯æ¬¡ refresh æœƒåŒæ™‚æ›ç™¼æ–°çš„ refreshTokenï¼ŒèˆŠçš„ç«‹å³å¤±æ•ˆï¼Œé˜²æ­¢ token è¢«ç«Šå–å¾Œé‡è¤‡ä½¿ç”¨ã€‚
  </div>
</div>
</body>
</html>
